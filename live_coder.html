<!doctype html>
<html>
  <head>
    <style>
      html, body { overflow: hidden; display: inline;}
      textarea { width: 90%; height: 75vh; display: inline; }
      .row {display: flex; grid-auto-flow: column; }
      .col {width:600px}
      .dot {height: 15px; width: 15px; border-radius: 50%; display: inline-block; }
      .red { background-color: red;}
      .green { background-color: green;}
      #log { font-family: "Lucida Console", "Courier New", monospace; font-size: 0.875em; }
    </style>
    <script src="lib/codemirror.js"></script>
    <script src="lib/addon/hint/show-hint.js"></script>
    <link rel="stylesheet" href="lib/codemirror.css">
    <link rel="stylesheet" src="lib/addon/hint/show-hint.css"></script>
    <script src="lib/addon/hint/javascript-hint.js"></script>
    <script src="lib/mode/javascript/javascript.js"></script>
    <script src="lib/addon/selection/mark-selection.js"></script>
    <script>
    </script>
</script>
  </head>
  <body>
    <div class="row">
      <div class="col"><canvas id="view"></canvas></div>
      <div class="col">
        <textarea id="code"></textarea>
        <p id="log"></p>
      </div>
    </div>

  </body>
  <script language="JavaScript">
    var textarea = document.getElementById('code');
    var myCodeMirror = CodeMirror.fromTextArea(textarea, {
          autofocus: true,
          lineNumbers: true,
          tabSize: 4,
          smartIndent: true,
          styleSelectedText: true,
          extraKeys: {
                "Ctrl-Space": "autocomplete",
          },
          mode: {
                name: "javascript",
                globalVars: true,
          }
                
        });
    myCodeMirror.setSize("600px", "600px");
    myCodeMirror.on("change", draw);

    function log(text) {
      document.getElementById("log").innerHTML = text.replace(/\n\r?/g, '<br/>');
    }

    function working(isWorking) {
      var color = isWorking ? "green" : "red";
      return '<span class="dot ' + color + '"></span>' 
    }

    document.addEventListener('keydown', logKey);

    function logKey(e) {
      //console.log(e.code);
      switch(e.code) {
        case "ControlLeft":

          toggleSlider();
          break;
        case "ControlRight":
          removeElement();
          break;
        }
    }


    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height)
      var code = myCodeMirror.getValue();
      try {
        log(working(true));
        eval(code);
        last_working_code = code;
      }catch(error) {
        log("<div>" + working(false) + " line " + error.lineNumber+ ": " + error + "</div>");
        eval(last_working_code);
      }
    }

    var added_elements = [];
    function toggleSlider() {
      if(added_elements.length == 0) {
        let highlit = document.getElementsByClassName("CodeMirror-selectedtext");
        let origCursor = myCodeMirror.getCursor();
        if(highlit.length > 0) {
          var origValue = myCodeMirror.getSelection();
          if(!isNaN(origValue)) {
            origValue = parseInt(origValue);
            let bumper = origValue * 3;
            let range = document.createElement('input');
            range.id = 'myRange';
            range.type = 'range';
            range.style = 'position:absolute;right:950px;top:650px;';
            range.min=origValue - bumper;
            range.max=origValue + bumper;
            range.value=origValue;
            range.addEventListener('input', updateInt);
            added_elements.push(range);
            document.body.appendChild(range);
          }
        }
      }
    }
    
    function updateInt() {
      var range = document.getElementById("myRange");
      var elem = document.getElementsByClassName("CodeMirror-selectedtext")[0];
      var origCursor = myCodeMirror.getCursor();
      myCodeMirror.replaceSelection(range.value);      
      myCodeMirror.setSelection({line: origCursor.line, ch: origcursor.ch}, {line: origCursor.line, ch: origCursor.ch - range.value.length});
    }

    function removeElement() {
      var elem = added_elements.pop();
      if(elem) { document.body.removeChild(elem); }
    }

    var canvas = document.querySelector('canvas');
    var ctx = canvas.getContext('2d');
    var last_working_code;
    var time=0;
    canvas.height=600;
    canvas.width=600;
    draw();

    //setInterval(draw, 50);
  </script>
</html>

