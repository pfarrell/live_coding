// From https://github.com/LivelyKernel/lively4-core/blob/e3c79acdd40794248dee1f4deb53eb8933aa5e89/src/babylonian-programming-editor/demos/presentation/03_canvas_simple.js
 var ctx, canvasWidth, canvasHeight;

// Scene
function drawScene(canvas) {
  ctx = canvas.getContext('2d');
  // extendCanvasContext(ctx);

  canvasWidth = parseInt(canvas.getAttribute("width"));
  canvasHeight = parseInt(canvas.getAttribute("height"));

  drawSky();
  drawMountains();
  drawTree();
}

// Sky
function drawSky() {
  ctx.save();

  var gradient = ctx.createLinearGradient(0, 0, 0, canvasHeight);
  gradient.addColorStop(0, "#b4e0fe");
  gradient.addColorStop(1, "#d3f8ff");

  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, canvasWidth, canvasHeight);

  ctx.restore();
}

// Mountains
function drawMountains() {
  resetRandom();
  drawMountain(130, "#8bb2bb");
  drawMountain(50, "#618087");
}

function drawMountain (offset, fillStyle) {
  var x = 0;
  var y = canvasHeight - offset;

  ctx.beginPath();
  ctx.moveTo(x, y);

  while (x >= 0 && x < canvasWidth) {
    x += random(2, 10);
    y += random(-4, 3);
    ctx.lineTo(x, y);
  }

  ctx.lineTo(canvasWidth, canvasHeight);
  ctx.lineTo(0, canvasHeight);
  ctx.closePath();

  ctx.fillStyle = fillStyle;
  ctx.fill();
}

// Tree
function drawTree() {
  var blossomPoints = [];

  resetRandom();
  drawBranches(0, -Math.PI/2, canvasWidth/2, canvasHeight, 30, blossomPoints);

  resetRandom();
  drawBlossoms(blossomPoints)
}

// Branches
function drawBranches(i, angle, x, y, width, blossomPoints) {
  ctx.save();

  var length = random(30, 50) * (1 - i/20);
  if (i == 0) { length = 100; }

  ctx.translate(x, y);
  ctx.rotate(angle);
  ctx.fillStyle = "#000";
  ctx.fillRect(0, -width/2, length, width);

  ctx.restore();

  var tipX = x + (length - width/2) * Math.cos(angle);
  var tipY = y + (length - width/2) * Math.sin(angle);

  if (i > 4) {
    blossomPoints.push([x, y, tipX, tipY]);
  }

  if (i < 6) {
    drawBranches(i + 1, angle + random(-0.55, -0.35), tipX-width/4, tipY, width/2, blossomPoints);
    drawBranches(i + 1, angle + random( 0.55, 0.35), tipX+width/4, tipY, width/2, blossomPoints);
  } else if (i < 8) {
    drawBranches(i + 1, angle + random( 0.25, -0.05), tipX+width/4, tipY, width/2, blossomPoints);
  }
}

// Blossoms
function drawBlossoms(blossomPoints) {
  var colors = ["#f5ceea", "#e8d9e4", "#f7c9f3", "#ebbdcc"];
  ctx.globalAlpha = 0.60;

  for (var i = 0; i < blossomPoints.length; i++) {
    var p = blossomPoints[i];
    for (var j = 0; j < 16; j++) {
      var x = lerp(p[0], p[2], random(0, 1)) + random(-10, 10);
      var y = lerp(p[1], p[3], random(0, 1)) + random(-10, 10);

      ctx.beginPath();
      ctx.fillStyle = colors[Math.floor(random(0, colors.length))];
      ctx.arc(x, y, random(2, 5), 0, Math.PI*2, true);
      ctx.fill();
    }
  }

  ctx.globalAlpha = 1.0;
}

var iter = 0;
function resetRandom() { iter = 0; }
// Tools
function random(low, high) {
  var seeds = [0.5204177389263173,0.9701081080319847,0.11342976804802174,0.28587958019681103,0.2468473697176562,0.7289544917732985,0.19127758468078337,0.9692678698691901,0.9205975129011617,0.6655288906779644,0.39379589578834895,0.7568241286365702,0.4571773887172823,0.8083990117920524,0.6851890151113024,0.9438770260874138,0.19893260389481693,0.8823212907053671,0.29538246446216443,0.9768550555603223,0.1385047487033687,0.7870162279320048,0.9707533858150311,0.5581042729775898,0.11691626916437203,0.8356243159039796,0.46716062873421615,0.8295472297469877,0.9852082724515482,0.6737843808132711,0.7984615665160968,0.16877446861183676,0.34803924726674607,0.06664330944676533,0.5305671856065948,0.0673203185643948,0.6658718777168352,0.3544926481971993,0.6031124701854809,0.5831092316120634,0.056934749742066915,0.7270870030250495,0.34295878149296743,0.4983166514750691,0.38086957108267994,0.8333570084202989,0.9757819445014883,0.8501656403249525,0.9105408328185055,0.8255448322701152,0.03211540006635438,0.22371530738125178,0.6956707365902902,0.48542632874727176,0.7750981829746982,0.5930807646325794,0.8850803874680341,0.342378081781612,0.8408634965183618,0.982915201771334,0.8895723681148346,0.2416832957979178,0.43539095999975497,0.873121845409386,0.5867351197443097,0.6062099377046437,0.07433564105271917,0.9970731260542177,0.374621890396156,0.011541018123842672,0.32698388395591826,0.39698190522279053,0.4344756587131139,0.3332876290542587,0.8526093833341141,0.2866045246224226,0.04029238547952574,0.7369546265995207,0.6783159847869233,0.09753760442244397,0.2840987439654544,0.8908805741570722,0.603427554845263,0.060675087341920175,0.6139652553309866,0.09185697080364308,0.5167307688468578,0.3120185130373032,0.6928610330659951,0.3808820311253788,0.3302794202546304,0.748128880609911,0.8420879352022619,0.5001845728382449,0.06569798048610986,0.377159899351622,0.9580787389737432,0.1426030668810726,0.229090629760361,0.31796018288437344,0.5905220756321762,0.483682326367613,0.7189094282788873,0.37443944834694265,0.5255130037922788,0.40822786868642247,0.472577768150793,0.5064182201959498,0.3932219173606011,0.7023360824418934,0.8455316997200591,0.22754068224426993,0.36804439395194977,0.8059558484811167,0.669381467460184,0.6506917560314144,0.7449687521538894,0.013079074632855625,0.40684823166554673,0.11012272936421863,0.15085867844055945,0.45136530109992434,0.10677163728132977,0.2320273140416782,0.5333358709261142,0.1289315527045498,0.2940009473241586,0.4164681913057632,0.8332165282288957,0.005609844593404523,0.3419113171908137,0.11970673064178639,0.7609097765607897,0.7327707042921066,0.1288231701360023,0.1960710314246379,0.11695177103827425,0.9399288457810571,0.39241718183495566,0.03569818486200804,0.6740391212145272,0.7198229799668348,0.14402837427846937,0.6065469443345187,0.039040914067532184,0.9885765529043361,0.3702148146615688,0.32049030297734393,0.9828558377856284,0.1303556852796548,0.49780887017071074,0.6280930182989443,0.6507502014510222,0.14888608737291442,0.9598701407635558,0.8516223994107156,0.22951224974183948,0.8367962668062658,0.8827965634325871,0.5206521537894948,0.30960390537540683,0.3361605303912927,0.3161723430727542,0.8161945623860506,0.26957292085234996,0.1817952535385623,0.374838772230888,0.07630059807921519,0.21409597562507166,0.28840538556773354,0.235590327645678,0.7238396802246306,0.5910997445797446,0.5343866476056002,0.9469725593229991,0.2781214214035007,0.1228218781553837,0.008602960296471007,0.22850410477593142,0.318156992882357,0.4419251637808408,0.7917317653737305,0.752441812843236,0.027926162631908058,0.9236820933195654,0.5293218718842033,0.6023254507439783,0.30712234445076014,0.06792219229607133,0.8015079765407541,0.21562788488560747,0.6524805585509822,0.3732468855173696,0.8292574514966096,0.6472172914661961,0.24858417509138964,0.45683683219481364,0.903110884696696,0.1442320308977978,0.5547060421514712,0.4292807077062444,0.45005823834657865,0.598787976420141,0.007123208203276388,0.7998956826524735,0.6500190270866404,0.5285523625133848,0.07158206557016611,0.21313550289329541,0.09041959946099742,0.5643460054524798,0.05809130310964772,0.9620794553145069,0.5635825081994174,0.06226609800695537,0.2649872055651681,0.7823430535291854,0.09723884018946183,0.5510575307488196,0.9735474056770839,0.8162266729344982,0.16011497522718499,0.9174584578944259,0.02378833349226983,0.43912083113264266,0.41208487865667154,0.38708037232812775,0.44048705728355386,0.6612358820517418,0.884955014442015,0.8439891191049937,0.8151751504672702,0.08645837749484053,0.5368505925037959,0.13356067946539407,0.7569205262132838,0.5554190291203823,0.34898016476040894,0.2881217470251839,0.6460969172815427,0.9459608054621487,0.1544938869640744,0.5905917698583121,0.09645027178282417,0.34268702161125486,0.7293683067294855,0.28914714766664384,0.12433483716711335,0.004982939933183217,0.6570382206949816,0.47224629428099385,0.8703102130849305,0.3777117900736683,0.29923343445546846,0.19387203855871704,0.9085664525245303,0.2489238368985337,0.5340206186035295,0.7929311805426547,0.6093610402908521,0.7308295798649008,0.6998497865017752,0.5651206802325575,0.3776578528179866,0.6584466698817272,0.9648141213215451,0.30304980820382266,0.7796586286731191,0.5516761415196835,0.4189402398284029,0.6284272934500857,0.7424490696297176,0.3949138535934198,0.696831069261849,0.8110698709208075,0.8025184318474846,0.21401643829243466,0.8943882646773363,0.6958910092676974,0.3624485860505108,0.5297565189527569,0.3094954014828314,0.5545031099938037,0.8670028117158621,0.057977419210818004,0.42629475153323515,0.21262170136862668,0.727918345645675,0.9360770597522167,0.8009320252377805,0.3870007635967354,0.044693292936447526,0.9033096623296207,0.3242064717939057,0.15393650894642474,0.8342945284081268,0.7096900826859946,0.6234924729490514,0.006515856785463514,0.43141794291496527,0.34074586191724643,0.9644065704413982,0.27225134781801374,0.17796060754818466,0.7365623878770768,0.32134530063307876,0.7349334047978578,0.1728762853783472,0.046721022843243976,0.5148727428637486,0.12266183587167911,0.7446305948558714,0.06346919698707976,0.041412893088735414,0.7104357918197514,0.25285387009043625,0.6882886899771911,0.44512322178221986,0.7388806522302532,0.571899953149385,0.4804441272243387,0.36010923103713255,0.39161303073538034,0.7183106011611521,0.6193634540511209,0.8504460802886277,0.25535268141393597,0.18016302398801698,0.36608515933650854,0.44188444811424177,0.22256984454301143,0.288590600060619,0.2541816803474196,0.5535542051529282,0.7905511803507461,0.49938772282999555,0.7596788559407739,0.9251031331655009,0.28701104497210805,0.8157815565114925,0.7577831487547044,0.7542730036545785,0.7218859436729443,0.41502636164795903,0.42741624985515236,0.47446881065866275,0.668168573549579,0.8244612801538633,0.9113409665168496,0.40840775155014153,0.44754558851420956,0.5674601582168545,0.633806519001631,0.2694200698619893,0.18840121022010825,0.5519205972860464,0.34100848009854334,0.36098177392461794,0.4883135992486958,0.4716396279960404,0.616437595875486,0.20325816666798002,0.48530874806972735,0.3506435529128805,0.7160703315977409,0.6714972239203434,0.2607375324934662,0.577871857862707,0.27150178218250154,0.18007042800811413,0.8581961526480105,0.40865765554846023,0.1647902923086092,0.6333569242935541,0.7963169536034153,0.13747966270244683,0.5760098484435571,0.4445648134873986,0.9587575351140937,0.4528077534016586,0.362112537879306,0.1865663646465191,0.9374872984619605,0.39768888900927835,0.9531189394297576,0.31898784079736286,0.5610380722040375,0.16413036459609354,0.051415707736983673,0.20580745486831897,0.36191294864169343,0.08471416291015199,0.10025902375619633,0.03511429005323541,0.0910584320328025,0.2137648215190664,0.6316004137532696,0.14356605244824083,0.22364291533971292,0.2981355442980397,0.3240370560580368,0.7289009353262379,0.0440161015407704,0.0747944912800278,0.35119090552480847,0.6612384212815171,0.2813993274429023,0.2915057453887443,0.37258172918564314,0.6912058258252042,0.36987215458921674,0.9677427811350044,0.15032922290480555,0.33665097198610583,0.05489104720477944,0.7627814493730366,0.23908007033077816,0.9247903555592906,0.6734051370258997,0.44491364003873224,0.12236258606289407,0.7924557947957057,0.2985760223413979,0.3654608781393468,0.8556164252221137,0.5170961422544217,0.8792777816872178,0.28513469775477107,0.27942126133761025,0.29894457959703213,0.5030094330086665,0.30445426973828915,0.736632711641,0.9407774438886487,0.2674838184151114,0.6023042353828298,0.22960161785196165,0.5158362850020015,0.2530770652934169,0.839485979803771,0.6153799522581722,0.7133251200398456,0.4030194128882376,0.45658413112019636,0.13172412109779363,0.957913568566962,0.804875731940086,0.4217970059925341,0.6054477606037973,0.41159872484243076,0.9936200937962477,0.22294999771765278,0.6873140778332678,0.6967391204600084,0.8818122342608256,0.6029482966753741,0.8834954831427092,0.11691818371256213,0.9540029593513564,0.030190513434598665,0.9115842481435688,0.5002926678305591,0.6752578214337444,0.2327143717070398,0.9091666790312409,0.28193968507772815,0.5074406352627944,0.724496324961406,0.6381191580388315,0.8338302653642055,0.6715024727336988,0.5674576049383934,0.8795277043503468,0.16446092490048436,0.1391514976468491,0.205504569831793,0.6712356012589531,0.17602004181638675,0.285763214204793,0.48734358774678077,0.5947070500121691,0.5575172077067174,0.514869158083338,0.6239152697685086,0.3362660920749848,0.5766260835160881,0.927684111898214,0.5422159941243199,0.2309757218556755,0.24976115861454717,0.7265654251891891,0.9672325358446887,0.8343468977934898,0.459502337201132,0.7006532668900939,0.2534247610768803,0.46373356676524957,0.3145430737644337,0.62780627690859,0.779067319844447];
  return seeds[iter++ % seeds.length] * (high- low) + low;
}

function lerp(a, b, distance) {
  return a + (b - a) * distance;
}/* Context: {"context":{"prescript":"","postscript":""},"customInstances":[]} */

canvas.width=600;
canvas.height=600;
drawScene(canvas);

